{% extends "base.html" %}

{% block title %}Submit Quote - Nook & Hook{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">Submit a Quote</h4>
                    <small class="text-muted">Earn ₦10 for each verified quote from your books</small>
                </div>
                <div class="card-body">
                    <!-- Instructions -->
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> How it works:</h6>
                        <ul class="mb-0">
                            <li>Select a book from your library or add a new one</li>
                            <li>Enter the exact quote as it appears in the book</li>
                            <li>Provide the correct page number</li>
                            <li>Our team will verify the quote and reward you ₦10 if approved</li>
                        </ul>
                    </div>

                    <form method="POST" id="quoteForm">
                        <!-- Book Selection -->
                        <div class="mb-4">
                            <label for="book_id" class="form-label">Select Book *</label>
                            <div class="row">
                                <div class="col-md-8">
                                    <select class="form-select" id="book_id" name="book_id" required>
                                        <option value="">Choose a book from your library...</option>
                                        {% for book in books %}
                                        <option value="{{ book._id }}">
                                            {{ book.title }}
                                            {% if book.authors %} by {{ book.authors|join(', ') }}{% endif %}
                                            ({{ book.status|title }})
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <button type="button" class="btn btn-outline-primary w-100" 
                                            data-bs-toggle="modal" data-bs-target="#addBookModal">
                                        <i class="fas fa-plus"></i> Add New Book
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Quote Text -->
                        <div class="mb-3">
                            <label for="quote_text" class="form-label">Quote Text *</label>
                            <textarea class="form-control" id="quote_text" name="quote_text" 
                                      rows="6" maxlength="1000" required
                                      placeholder="Enter the exact quote as it appears in the book..."></textarea>
                            <div class="form-text">
                                <span id="charCount">0</span>/1000 characters. 
                                <strong>Important:</strong> Quote must be exactly as written in the book.
                            </div>
                        </div>

                        <!-- Page Number -->
                        <div class="mb-4">
                            <label for="page_number" class="form-label">Page Number *</label>
                            <input type="number" class="form-control" id="page_number" name="page_number" 
                                   min="1" required placeholder="Enter the page number where this quote appears">
                        </div>

                        <!-- Submit Button -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{{ url_for('quotes.index') }}" class="btn btn-secondary me-md-2">Cancel</a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i> Submit Quote
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tips Card -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-lightbulb"></i> Tips for Success</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-success">✓ Do:</h6>
                            <ul class="small">
                                <li>Copy quotes exactly as written</li>
                                <li>Include proper punctuation</li>
                                <li>Double-check page numbers</li>
                                <li>Choose meaningful passages</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-danger">✗ Don't:</h6>
                            <ul class="small">
                                <li>Paraphrase or modify quotes</li>
                                <li>Submit very short quotes (under 10 chars)</li>
                                <li>Use incorrect page numbers</li>
                                <li>Submit duplicate quotes</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Book Modal -->
<div class="modal fade" id="addBookModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Book</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="bookSearch" class="form-label">Search for Books</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="bookSearch" 
                               placeholder="Enter book title, author, or ISBN...">
                        <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                </div>
                
                <div id="searchResults" class="mt-3"></div>
                <div id="searchLoading" class="text-center mt-3" style="display: none;">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Searching...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Character counter
document.getElementById('quote_text').addEventListener('input', function() {
    const charCount = this.value.length;
    document.getElementById('charCount').textContent = charCount;
    
    if (charCount > 1000) {
        this.classList.add('is-invalid');
    } else {
        this.classList.remove('is-invalid');
    }
});

// Book search functionality
document.getElementById('searchBtn').addEventListener('click', searchBooks);
document.getElementById('bookSearch').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        searchBooks();
    }
});

function searchBooks() {
    const query = document.getElementById('bookSearch').value.trim();
    if (!query) return;
    
    const searchResults = document.getElementById('searchResults');
    const searchLoading = document.getElementById('searchLoading');
    
    searchLoading.style.display = 'block';
    searchResults.innerHTML = '';
    
    fetch(`{{ url_for('quotes.search_books') }}?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            searchLoading.style.display = 'none';
            
            if (data.books && data.books.length > 0) {
                let html = '<div class="row">';
                data.books.forEach(book => {
                    html += `
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <div class="d-flex">
                                        ${book.cover_url ? `<img src="${book.cover_url}" alt="Cover" class="me-3" style="width: 60px; height: 90px; object-fit: cover;">` : ''}
                                        <div class="flex-grow-1">
                                            <h6 class="card-title">${book.title}</h6>
                                            ${book.authors.length > 0 ? `<p class="card-text small text-muted">by ${book.authors.join(', ')}</p>` : ''}
                                            <p class="card-text small">${book.page_count} pages</p>
                                            <button class="btn btn-sm btn-primary" onclick="addBookToLibrary('${book.google_id}', '${book.title.replace(/'/g, "\\'")}')">
                                                <i class="fas fa-plus"></i> Add to Library
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                searchResults.innerHTML = html;
            } else {
                searchResults.innerHTML = '<div class="alert alert-info">No books found. Try a different search term.</div>';
            }
        })
        .catch(error => {
            searchLoading.style.display = 'none';
            searchResults.innerHTML = '<div class="alert alert-danger">Error searching for books. Please try again.</div>';
            console.error('Search error:', error);
        });
}

function addBookToLibrary(googleId, title) {
    fetch('{{ url_for("quotes.add_book") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            google_id: googleId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Add book to the select dropdown
            const bookSelect = document.getElementById('book_id');
            const option = document.createElement('option');
            option.value = data.book_id;
            option.textContent = title + ' (To Read)';
            option.selected = true;
            bookSelect.appendChild(option);
            
            // Close modal and show success message
            const modal = bootstrap.Modal.getInstance(document.getElementById('addBookModal'));
            modal.hide();
            
            // Show success alert
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
                <i class="fas fa-check-circle"></i> ${data.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.row'));
        } else {
            alert('Error: ' + (data.error || 'Failed to add book'));
        }
    })
    .catch(error => {
        console.error('Add book error:', error);
        alert('Error adding book. Please try again.');
    });
}

// Form validation
document.getElementById('quoteForm').addEventListener('submit', function(e) {
    const quoteText = document.getElementById('quote_text').value.trim();
    const pageNumber = document.getElementById('page_number').value;
    const bookId = document.getElementById('book_id').value;
    
    if (!bookId) {
        e.preventDefault();
        alert('Please select a book.');
        return;
    }
    
    if (quoteText.length < 10) {
        e.preventDefault();
        alert('Quote must be at least 10 characters long.');
        return;
    }
    
    if (!pageNumber || pageNumber < 1) {
        e.preventDefault();
        alert('Please enter a valid page number.');
        return;
    }
});
</script>
{% endblock %}